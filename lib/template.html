<html>
	<head>
		<style id="museum_style">
			/* This gets overwritten by the museum's own style */
		</style>
		<script id="museum_script">
			// This gets overwritten by the museum's own style
			function show_me_background(
				initiated, // When the request began in ms past 1970
				expected, // When the cabinet will display, if known
			) {
				console.log(initiated, expected);
				return ""; // The style to apply to the background
			}
		</script>
		<script>
			class ShowMe {
				constructor(div) {
					// Stash details from global and arguments
					this.initiated = new Date().getTime();
					this.renderFunction = show_me_background;
					this.div = div;

					// Clear any previous background animation
					const oldIntervalId = div.getAttribute("show_me_interval_id");
					if (oldIntervalId) {
						window.clearInterval(parseInt(oldIntervalId));
					}

					// Set a new animation running
					this.intervalId = window.setInterval(this.render.bind(this), 40);
					div.setAttribute("show_me_interval_id", this.intervalId);

					// Request the effect and catch the response
					this.xhr = new XMLHttpRequest();
					this.xhr.onreadystatechange = this.update.bind(this);
					this.xhr.open("GET", div.getAttribute("href"));
					this.xhr.send();
				}

				render() {
					// If we have an ETA and it is in the past
					if (this.expected && new Date().getTime() > this.expected) {
						// Clear the background and the animation
						this.div.style.background = "";
						this.div.setAttribute("show_me_interval_id", null);
						window.clearInterval(this.intervalId);
					} else {
						// Set the background from the museum's files
						this.div.style.background = this.renderFunction(
							this.initiated,
							this.expected,
						);
					}
				}

				update() {
					// Catch the done event
					if (this.xhr.readyState === this.xhr.DONE && this.xhr.status === 200) {
						// Store the ETA of the effect
						this.expected = parseInt(this.xhr.responseText);
					}
				}

			}
		</script>
	</head>
	<body>
		<div id="page_content">
			<!-- This gets overwritten by the page content -->
			<a href="" onclick="new ShowMe(this); return false;"></a>
		</div>
	</body>
</html>
